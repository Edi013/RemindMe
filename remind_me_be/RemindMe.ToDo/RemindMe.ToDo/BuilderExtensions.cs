using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.EntityFrameworkCore;
using Microsoft.IdentityModel.Tokens;
using RemindMe.Application.Handlers.Todos;
using RemindMe.DataAcces;
using RemindMe.DataAcces.Repositories;
using RemindMe.Domain.Interfaces;
using System.Net;
using System.Security.Cryptography.X509Certificates;
using System.Text;

namespace RemindMe
{
    public static class BuilderExtensions
    {
        public static void RegisterServices(this WebApplicationBuilder builder)
        {
            builder.ConfigureLogging();


            builder.Services.AddControllers();
            builder.Services.AddEndpointsApiExplorer();

            builder.ConfigureCors();

            builder.RegisterSwaggerSettings();

            builder.Services.AddMediatR(
                 cfg => cfg.RegisterServicesFromAssemblies(typeof(GetAllByUserIdItemHandler).Assembly));

            var connectionString = builder.Configuration.GetConnectionString("RemindMeDb");
            builder.Services.AddDbContext<ApplicationDbContext>(options => options.UseNpgsql(connectionString));

            var audience = new List<string>{
                            builder.Configuration.GetSection("JWT:ValidAudience:Postman").Value,
                            builder.Configuration.GetSection("JWT:ValidAudience:FlutterClient").Value,
                            builder.Configuration.GetSection("JWT:ValidAudience:TodoService").Value,
            };
            builder.Services
                .AddAuthentication(options =>
                {
                    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
                    options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
                })
                /*.AddAuthentication(options =>
                {
                    options.DefaultScheme = CookieAuthenticationDefaults.AuthenticationScheme;
                    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
                })
                .AddCookie(CookieAuthenticationDefaults.AuthenticationScheme, options =>
                {
                    options.Cookie.Name = "Jwt"; 
                    *//*options.Events = new CookieAuthenticationEvents
                    {
                        OnValidatePrincipal = context =>
                        {
                            // Custom logic to validate the principal from the cookie
                            // You may check the cookie content, expiration, etc.
                            // If validation fails, set context.RejectPrincipal();
                            return Task.CompletedTask;
                        }
                    };*//*
                })*/
                .AddJwtBearer(options =>
                {
                    options.SaveToken = true;
                    options.RequireHttpsMetadata = false;
                    /*options.TokenValidationParameters = new TokenValidationParameters
                    {
                        ValidateIssuer = true,
                        ValidateAudience = true,
                        ValidateLifetime = true,
                        RequireExpirationTime = true,
                        ValidIssuer = builder.Configuration.GetSection("JWT:ValidIssuer").Value,
                        ValidAudiences = audience,
                        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(
                            builder.Configuration.GetSection("JWT:Secret").Value)),
                        ClockSkew = TimeSpan.Zero
                    };*/
                }
            );
            ;

            builder.RegisterAppSettings();
            builder.Services.AddScoped<IItemRepository, ItemRepository>();
        }
        public static void ConfigureLogging(this WebApplicationBuilder builder)
        {
            builder.Logging.ClearProviders();
            builder.Logging.AddLog4Net(log4NetConfigFile: "log4net.config");
        }

        private static void ConfigureCors(this WebApplicationBuilder builder)
        {
            string[] authorizedUrls = new string[] { };
            authorizedUrls.Append(builder.Configuration.GetSection("AuthorizedUrls:EmailingService").Value);
            authorizedUrls.Append(builder.Configuration.GetSection("AuthorizedUrls:FrontendAppUrl").Value);
            
            builder.Services.AddCors(options =>
            {
                options.AddPolicy(name: "TodoPolicy",
                                          policy =>
                                          {
                                              policy
                                              .AllowAnyOrigin()
                                              //.WithOrigins(builder.Configuration.GetSection("FrontendApp:Url").Value)
                                              .AllowAnyHeader()
                                              .AllowAnyMethod();
                                              //.AllowCredentials();
                                          });
            });
        }

        private static void RegisterSwaggerSettings(this WebApplicationBuilder builder)
        {
            builder.Services.AddSwaggerGen();
        }
        
        private static void RegisterAppSettings(this WebApplicationBuilder builder)
        {
            var configuration = new ConfigurationBuilder()
            .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)
            .Build();
            builder.Services.AddSingleton(configuration);
        }
    }
}
